<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple API Test</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%231a1a1a'/><text x='8' y='11' font-family='monospace' font-size='12' font-weight='bold' text-anchor='middle' fill='%2300ff00'>$</text></svg>" type="image/svg+xml">
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        button {
            background: #333;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        #output {
            background: #000;
            border: 1px solid #333;
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Simple Multiplayer API Test</h1>
    
    <button onclick="testCreateGame()">Test Create Game</button>
    <button onclick="checkAuth()">Check Auth</button>
    <button onclick="testBadAllocation()">Test Bad Allocation (should fail)</button>
    
    <div id="output">Ready...</div>
    
    <!-- Load scripts in order -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    
    <script>
        // Simple logging
        function log(msg) {
            const output = document.getElementById('output');
            output.textContent += '\n' + new Date().toISOString() + ' - ' + msg;
        }
        
        // Declare client in outer scope
        let client;
        
        // Initialize function
        async function initializeSupabase() {
            // Wait for config to be available
            let attempts = 0;
            const maxAttempts = 50;
            
            while ((!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) && attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.SUPABASE_URL || !window.SUPABASE_ANON_KEY) {
                log('ERROR: Supabase config not loaded after ' + attempts + ' attempts');
                return false;
            }
            
            // Initialize Supabase
            try {
                const { createClient } = supabase;
                client = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                log('Supabase client initialized');
                return true;
            } catch (error) {
                log('ERROR initializing Supabase: ' + error.message);
                return false;
            }
        }
        
        // Wait for everything to load then initialize
        window.addEventListener('load', async function() {
            const initialized = await initializeSupabase();
            if (initialized) {
                // Check auth on load
                checkAuth();
            }
        });
        
        async function checkAuth() {
            try {
                if (!client) {
                    log('ERROR: Supabase client not initialized');
                    return;
                }
                const { data: { session } } = await client.auth.getSession();
                if (session) {
                    log('Authenticated as: ' + session.user.email);
                } else {
                    log('Not authenticated - please login at http://localhost:8001/');
                }
            } catch (error) {
                log('Auth check error: ' + error.message);
            }
        }
        
        async function testCreateGame() {
            try {
                if (!client) {
                    log('ERROR: Supabase client not initialized');
                    return;
                }
                
                log('Getting auth token...');
                const { data: { session } } = await client.auth.getSession();
                if (!session) {
                    log('ERROR: Not authenticated');
                    return;
                }
                
                const payload = {
                    duration: 30,
                    allocations: { BTC: 4, ETH: 3, SOL: 3 }
                };
                
                const headers = {
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json',
                    'apikey': window.SUPABASE_ANON_KEY
                };
                
                log('Calling create-game function...');
                log('URL: ' + window.SUPABASE_URL + '/functions/v1/create-game');
                log('Headers: ' + JSON.stringify(headers, null, 2));
                log('Payload: ' + JSON.stringify(payload, null, 2));
                
                const response = await fetch(`${window.SUPABASE_URL}/functions/v1/create-game`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });
                
                log('Response status: ' + response.status);
                log('Response headers: ' + [...response.headers.entries()].map(h => h.join(': ')).join(', '));
                
                const data = await response.json();
                log('Response: ' + JSON.stringify(data, null, 2));
                
                if (data.success) {
                    log('SUCCESS! Game Code: ' + data.data.game_code);
                } else {
                    log('ERROR from server: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                log('ERROR: ' + error.message);
            }
        }
        
        async function testBadAllocation() {
            try {
                if (!client) {
                    log('ERROR: Supabase client not initialized');
                    return;
                }
                
                log('Testing with bad allocation (should fail)...');
                const { data: { session } } = await client.auth.getSession();
                if (!session) {
                    log('ERROR: Not authenticated');
                    return;
                }
                
                const badPayload = {
                    duration: 30,
                    allocations: { BTC: 5, ETH: 3, SOL: 1 } // Only sums to 9, should be 10
                };
                
                log('Sending bad payload: ' + JSON.stringify(badPayload));
                
                const response = await fetch(`${window.SUPABASE_URL}/functions/v1/create-game`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`,
                        'Content-Type': 'application/json',
                        'apikey': window.SUPABASE_ANON_KEY
                    },
                    body: JSON.stringify(badPayload)
                });
                
                log('Response status: ' + response.status);
                const data = await response.json();
                log('Response: ' + JSON.stringify(data, null, 2));
                
                if (!data.success && data.error === 'Allocations must sum to 10') {
                    log('SUCCESS: Error handling works correctly!');
                }
            } catch (error) {
                log('ERROR: ' + error.message);
            }
        }
    </script>
</body>
</html> 