<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLS Policy Verification</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0ff;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #0ff;
        }
        .success { color: #0f0; }
        .error { color: #f00; }
        .info { color: #ff0; }
        .debug { color: #888; }
        button {
            background: #0ff;
            color: #000;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-family: inherit;
            margin: 5px;
        }
        button:hover {
            background: #0aa;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #authStatus {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #666;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
        }
        pre {
            background: #111;
            padding: 10px;
            overflow-x: auto;
        }
        
        #log {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #222;
        }
        
        .log-time {
            color: #666;
            margin-right: 10px;
        }
        
        #copyBtn {
            background: #0f0;
            float: right;
        }
        
        .nav-links {
            margin: 20px 0;
        }
        
        .nav-links a {
            color: #0ff;
            margin-right: 20px;
        }
    </style>
</head>
<body>
    <h1>RLS Policy Verification</h1>
    
    <div class="nav-links">
        <a href="/">Main Game</a>
        <a href="/test-auth-enhanced.html">Enhanced Auth Test</a>
        <a href="/test-auth-simple.html">Simple Auth Test</a>
        <a href="/test-multiplayer-comprehensive.html">Multiplayer Test</a>
    </div>
    
    <div class="section">
        <h2>Current Auth Status</h2>
        <div id="authStatus">Checking...</div>
        <button onclick="signOut()">Sign Out</button>
        <button onclick="location.reload()">Refresh</button>
    </div>

    <div class="section">
        <h2>Test 1: Anonymous User Queries</h2>
        <p>Verify that anonymous users can view multiplayer games</p>
        <button onclick="testAnonymousAccess()">Run Test</button>
        <div id="test1Result" class="result"></div>
    </div>
    
    <div class="section">
        <h2>Test 2: Authenticated User Queries</h2>
        <p>Verify that authenticated users see their own games + other multiplayer games</p>
        <button onclick="testAuthenticatedAccess()">Run Test</button>
        <div id="test2Result" class="result"></div>
    </div>
    
    <div class="section">
        <h2>Test 3: Game Participants Access</h2>
        <p>Verify that game participants are publicly readable</p>
        <button onclick="testParticipantsAccess()">Run Test</button>
        <div id="test3Result" class="result"></div>
    </div>
    
    <div class="section">
        <h2>Test 4: Find Game by Code</h2>
        <p>Verify that games can be found by their code (case-sensitive)</p>
        <input type="text" id="gameCode" placeholder="Enter game code (e.g., Q92U)" style="background: #111; color: #0ff; border: 1px solid #0ff; padding: 5px;">
        <button onclick="testFindByCode()">Search</button>
        <div id="test4Result" class="result"></div>
    </div>
    
    <div class="section">
        <h2>Debug Log <button id="copyBtn" onclick="copyLog()">Copy Log</button></h2>
        <div id="log"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./config.js"></script>
    <script type="module">
        // Import auth module which will use the global supabase
        import { auth } from './auth.js';
        
        // Store auth in window for easy access
        window.auth = auth;
        
        // Initialize log
        const logEntries = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const entry = {
                time: timestamp,
                type: type,
                message: message
            };
            logEntries.push(entry);
            
            const logEl = document.getElementById('log');
            const entryEl = document.createElement('div');
            entryEl.className = `log-entry ${type}`;
            entryEl.innerHTML = `<span class="log-time">${timestamp.split('T')[1]}</span><span class="${type}">[${type.toUpperCase()}] ${escapeHtml(message)}</span>`;
            logEl.appendChild(entryEl);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        window.copyLog = function() {
            const logText = logEntries.map(entry => 
                `${entry.time} [${entry.type.toUpperCase()}] ${entry.message}`
            ).join('\n');
            
            navigator.clipboard.writeText(logText).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.textContent = 'Copied!';
                setTimeout(() => {
                    btn.textContent = 'Copy Log';
                }, 2000);
            }).catch(err => {
                log('Failed to copy: ' + err, 'error');
            });
        }
        
        // Check auth status
        async function checkAuthStatus() {
            log('Checking authentication status...', 'info');
            try {
                // Get the current user
                const user = await auth.getCurrentUser();
                
                const statusEl = document.getElementById('authStatus');
                if (user) {
                    log(`Authenticated as: ${user.email}`, 'success');
                    statusEl.innerHTML = `‚úÖ Authenticated as: ${user.email}`;
                    statusEl.className = 'success';
                } else {
                    log('Not authenticated (anonymous)', 'info');
                    statusEl.innerHTML = '‚ö†Ô∏è Not authenticated (anonymous)';
                    statusEl.className = 'info';
                }
            } catch (error) {
                log(`Auth check error: ${error.message}`, 'error');
                console.error('Auth check error:', error);
                const statusEl = document.getElementById('authStatus');
                statusEl.innerHTML = `‚ùå Error checking auth: ${error.message}`;
                statusEl.className = 'error';
            }
        }
        
        // Sign out
        window.signOut = async function() {
            log('Signing out...', 'info');
            await auth.signOut();
            location.reload();
        }
        
        // Test 1: Anonymous access
        window.testAnonymousAccess = async function() {
            const resultEl = document.getElementById('test1Result');
            resultEl.innerHTML = '<span class="info">Running test...</span>';
            log('Test 1: Anonymous access - Starting', 'info');
            
            try {
                // Sign out first to ensure anonymous
                await auth.signOut();
                log('Signed out for anonymous test', 'debug');
                
                // Try to query multiplayer games
                const { data, error } = await auth.supabase
                    .from('active_games')
                    .select('id, game_code, user_id, participant_count, duration_days, created_at')
                    .eq('is_multiplayer', true)
                    .eq('is_complete', false);
                
                if (error) {
                    log(`Anonymous query error: ${error.message}`, 'error');
                    resultEl.innerHTML = `<span class="error">‚úó Error: ${error.message}</span>`;
                } else {
                    log(`Anonymous query successful: Found ${data.length} games`, 'success');
                    resultEl.innerHTML = `
                        <span class="success">‚úì Success! Found ${data.length} multiplayer games</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                log(`Test 1 exception: ${e.message}`, 'error');
                resultEl.innerHTML = `<span class="error">‚úó Exception: ${e.message}</span>`;
            }
        }
        
        // Test 2: Authenticated access
        window.testAuthenticatedAccess = async function() {
            const resultEl = document.getElementById('test2Result');
            resultEl.innerHTML = '<span class="info">Running test...</span>';
            log('Test 2: Authenticated access - Starting', 'info');
            
            try {
                const user = await auth.getCurrentUser();
                if (!user) {
                    log('Must be authenticated for this test', 'error');
                    resultEl.innerHTML = '<span class="error">‚úó Must be authenticated for this test</span>';
                    return;
                }
                
                log(`Running authenticated query as ${user.email}`, 'debug');
                
                // Query all games (should see own + multiplayer)
                const { data, error } = await auth.supabase
                    .from('active_games')
                    .select('id, game_code, user_id, is_multiplayer, participant_count')
                    .eq('is_complete', false);
                
                if (error) {
                    log(`Authenticated query error: ${error.message}`, 'error');
                    resultEl.innerHTML = `<span class="error">‚úó Error: ${error.message}</span>`;
                } else {
                    const ownGames = data.filter(g => g.user_id === user.id);
                    const otherMultiplayer = data.filter(g => g.user_id !== user.id && g.is_multiplayer);
                    
                    log(`Query successful - Own: ${ownGames.length}, Other MP: ${otherMultiplayer.length}`, 'success');
                    
                    resultEl.innerHTML = `
                        <span class="success">‚úì Success!</span>
                        <br>Own games: ${ownGames.length}
                        <br>Other multiplayer games: ${otherMultiplayer.length}
                        <br>Total visible: ${data.length}
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                log(`Test 2 exception: ${e.message}`, 'error');
                resultEl.innerHTML = `<span class="error">‚úó Exception: ${e.message}</span>`;
            }
        }
        
        // Test 3: Game participants access
        window.testParticipantsAccess = async function() {
            const resultEl = document.getElementById('test3Result');
            resultEl.innerHTML = '<span class="info">Running test...</span>';
            log('Test 3: Game participants access - Starting', 'info');
            
            try {
                // Get any multiplayer game
                log('Looking for multiplayer games...', 'debug');
                const { data: games } = await auth.supabase
                    .from('active_games')
                    .select('id, game_code')
                    .eq('is_multiplayer', true)
                    .limit(1);
                
                if (!games || games.length === 0) {
                    log('No multiplayer games found to test', 'info');
                    resultEl.innerHTML = '<span class="info">‚óã No multiplayer games found to test</span>';
                    return;
                }
                
                log(`Found game ${games[0].game_code}, checking participants...`, 'debug');
                
                // Try to read participants
                const { data, error } = await auth.supabase
                    .from('game_participants')
                    .select('*, profiles:user_id(email)')
                    .eq('game_id', games[0].id);
                
                if (error) {
                    log(`Participants query error: ${error.message}`, 'error');
                    resultEl.innerHTML = `<span class="error">‚úó Error: ${error.message}</span>`;
                } else {
                    log(`Found ${data.length} participants for game ${games[0].game_code}`, 'success');
                    resultEl.innerHTML = `
                        <span class="success">‚úì Success! Game ${games[0].game_code} has ${data.length} participants</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                log(`Test 3 exception: ${e.message}`, 'error');
                resultEl.innerHTML = `<span class="error">‚úó Exception: ${e.message}</span>`;
            }
        }
        
        // Test 4: Find by code
        window.testFindByCode = async function() {
            const resultEl = document.getElementById('test4Result');
            const gameCode = document.getElementById('gameCode').value.trim();
            
            if (!gameCode) {
                log('No game code entered', 'error');
                resultEl.innerHTML = '<span class="error">‚úó Please enter a game code</span>';
                return;
            }
            
            log(`Test 4: Finding game by code '${gameCode}'`, 'info');
            resultEl.innerHTML = '<span class="info">Searching...</span>';
            
            try {
                const { data, error } = await auth.supabase
                    .from('active_games')
                    .select('*')
                    .eq('game_code', gameCode)
                    .eq('is_multiplayer', true)
                    .eq('is_complete', false)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        log(`No game found with code: ${gameCode}`, 'info');
                        resultEl.innerHTML = `<span class="info">‚óã No game found with code: ${gameCode}</span>`;
                    } else {
                        log(`Find by code error: ${error.message}`, 'error');
                        resultEl.innerHTML = `<span class="error">‚úó Error: ${error.message}</span>`;
                    }
                } else {
                    log(`Found game with code ${gameCode}!`, 'success');
                    resultEl.innerHTML = `
                        <span class="success">‚úì Found game!</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                }
            } catch (e) {
                log(`Test 4 exception: ${e.message}`, 'error');
                resultEl.innerHTML = `<span class="error">‚úó Exception: ${e.message}</span>`;
            }
        }
        
        // Initialize
        log('Page loaded', 'info');
        log(`Current URL: ${window.location.href}`, 'debug');
        checkAuthStatus();
        
        // Listen for auth state changes
        auth.supabase.auth.onAuthStateChange((event, session) => {
            log(`Auth state changed: ${event}`, 'info');
            checkAuthStatus();
        });
    </script>
</body>
</html>