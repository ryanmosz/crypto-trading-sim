<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Multiplayer Test</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%231a1a1a'/><text x='8' y='11' font-family='monospace' font-size='12' font-weight='bold' text-anchor='middle' fill='%2300ff00'>$</text></svg>" type="image/svg+xml">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1, h2 {
            color: #00ff00;
            font-family: 'Arial Black', sans-serif;
        }
        .section {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
        }
        button:hover {
            background: #00cc00;
        }
        button:disabled {
            background: #666;
            color: #999;
            cursor: not-allowed;
        }
        input, select {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
        }
        #output {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 1px solid #444;
            border-radius: 4px;
        }
        .error {
            color: #ff0066;
        }
        .success {
            color: #00ff00;
        }
        .info {
            color: #00ffff;
        }
        .warning {
            color: #ffff00;
        }
        .user-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #333;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #555;
        }
        .test-case {
            margin: 10px 0;
            padding: 10px;
            background: #222;
            border-radius: 4px;
        }
        .game-code {
            font-size: 24px;
            font-family: 'Arial Black', sans-serif;
            color: #00ffff;
            background: #111;
            padding: 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="user-info">
        <strong>Current User:</strong> <span id="currentUser">Not logged in</span>
    </div>

    <h1>üéÆ Comprehensive Multiplayer Testing</h1>
    
    <div class="section">
        <h2>üìã Test Instructions</h2>
        <p>Open this page in two different browsers:</p>
        <ol>
            <li><strong>Browser 1:</strong> Log in as adam@test.com</li>
            <li><strong>Browser 2:</strong> Log in as beth@test.com</li>
            <li>Create a game in Browser 1, get the code</li>
            <li>Join the game in Browser 2 using the code</li>
            <li>Test various scenarios below</li>
        </ol>
    </div>

    <div class="section">
        <h2>üéØ Quick Actions</h2>
        <button onclick="createQuickGame()">Create 30-Day Game</button>
        <button onclick="showMyGames()">Show My Games</button>
        <button onclick="showAllActiveGames()">Show All Active Games</button>
        <button onclick="refreshPrices()">Refresh Prices</button>
    </div>

    <div class="section">
        <h2>üé≤ Create Game Tests</h2>
        <div class="test-case">
            <h3>Standard Game Creation</h3>
            Duration: <select id="duration">
                <option value="30">30 days</option>
                <option value="60">60 days</option>
                <option value="90">90 days</option>
            </select><br>
            BTC: <input type="number" id="btc" value="4" min="0" max="10"><br>
            ETH: <input type="number" id="eth" value="3" min="0" max="10"><br>
            SOL: <input type="number" id="sol" value="3" min="0" max="10"><br>
            <button onclick="createGame()">Create Game</button>
        </div>
        
        <div class="test-case">
            <h3>Edge Case Tests</h3>
            <button onclick="createGameBadAllocation()">Bad Allocation (sum ‚â† 10)</button>
            <button onclick="createGameAllBTC()">All BTC (10-0-0)</button>
            <button onclick="createGameMinAllocation()">Min Allocation (1-1-1)</button>
        </div>
    </div>

    <div class="section">
        <h2>üîç Find & Join Game Tests</h2>
        <div class="test-case">
            <h3>Find Game by Code</h3>
            Game Code: <input type="text" id="gameCode" placeholder="Enter 4 chars" maxlength="4">
            <button onclick="findGame()">Find Game</button>
            <button onclick="findGameWrongCase()">Test Wrong Case</button>
        </div>
        
        <div class="test-case">
            <h3>Join Game</h3>
            <div id="foundGameInfo" style="display:none;">
                <p>Game Found: <span id="foundGameDetails"></span></p>
                <button onclick="joinFoundGame()">Join This Game</button>
                <button onclick="joinWithDifferentAllocation()">Join with Different Allocation</button>
            </div>
        </div>
        
        <div class="test-case">
            <h3>Edge Cases</h3>
            <button onclick="joinOwnGame()">Try Join Own Game</button>
            <button onclick="joinAlreadyJoined()">Try Join Again</button>
            <button onclick="joinExpiredGame()">Find Expired Game</button>
        </div>
    </div>

    <div class="section">
        <h2>üìä Leaderboard & Updates</h2>
        <div class="test-case">
            <h3>View Game Details</h3>
            <select id="gameSelect">
                <option value="">Select a game...</option>
            </select>
            <button onclick="viewGameDetails()">View Details</button>
            <button onclick="viewLeaderboard()">View Leaderboard</button>
        </div>
        
        <div class="test-case">
            <h3>Price Updates</h3>
            <button onclick="triggerPriceUpdate()">Trigger Price Update</button>
            <button onclick="checkLastUpdate()">Check Last Update Time</button>
        </div>
    </div>

    <div class="section">
        <h2>üß™ Stress Tests</h2>
        <button onclick="createMultipleGames()">Create 5 Games Rapidly</button>
        <button onclick="joinMultipleGames()">Join 5 Different Games</button>
        <button onclick="rapidFireRequests()">Rapid Fire API Calls</button>
    </div>

    <div class="section">
        <h2>üìù Output Log</h2>
        <div id="output">Ready for testing...
Instructions:
1. Open in Browser 1 and log in as adam@test.com
2. Open in Browser 2 (private/incognito) and log in as beth@test.com
3. Start testing!</div>
    </div>

    <!-- Load dependencies -->
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="module">
        // Import our API functions
        import { createNowGame, joinNowGame, findGameByCode, getGameParticipants } from './services/nowGameApi.js';
        import { formatGameCode, validateGameCode, isGameActive } from './utils/slug.js';
        
        // Initialize
        let supabaseClient;
        let currentGameId = null;
        let foundGame = null;
        
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toISOString();
            const typeSymbol = {
                'error': '‚ùå',
                'success': '‚úÖ',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            }[type] || '';
            
            output.textContent += `\n${timestamp} ${typeSymbol} - ${message}`;
            output.scrollTop = output.scrollHeight;
            console.log(`[${type}]`, message);
        }
        
        // Initialize Supabase
        async function initializeSupabase() {
            try {
                const { createClient } = supabase;
                supabaseClient = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
                window.supabase = supabaseClient;
                
                // Check auth
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    document.getElementById('currentUser').textContent = user.email;
                    log(`Authenticated as: ${user.email}`, 'success');
                    loadUserGames();
                } else {
                    document.getElementById('currentUser').textContent = 'Not logged in';
                    log('Not authenticated - please login at http://localhost:8001/', 'warning');
                }
            } catch (error) {
                log(`Initialization error: ${error.message}`, 'error');
            }
        }
        
        // Load user's games for dropdown
        async function loadUserGames() {
            try {
                const { data: games, error } = await supabaseClient
                    .from('active_games')
                    .select('*')
                    .eq('is_multiplayer', true)
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                const select = document.getElementById('gameSelect');
                select.innerHTML = '<option value="">Select a game...</option>';
                
                games.forEach(game => {
                    const option = document.createElement('option');
                    option.value = game.id;
                    option.textContent = `${formatGameCode(game.game_code)} - ${game.duration_days} days - ${game.participant_count} players`;
                    select.appendChild(option);
                });
            } catch (error) {
                log(`Error loading games: ${error.message}`, 'error');
            }
        }
        
        // Quick game creation
        window.createQuickGame = async function() {
            log('Creating quick 30-day game...', 'info');
            try {
                const result = await createNowGame({
                    duration: 30,
                    allocations: { BTC: 4, ETH: 3, SOL: 3 }
                });
                
                currentGameId = result.game_id;
                log(`Game created! Code: ${formatGameCode(result.game_code)}`, 'success');
                
                // Display prominently
                const codeDiv = document.createElement('div');
                codeDiv.className = 'game-code';
                codeDiv.textContent = `Game Code: ${formatGameCode(result.game_code)}`;
                document.getElementById('output').appendChild(codeDiv);
                
                loadUserGames();
            } catch (error) {
                log(`Create failed: ${error.message}`, 'error');
            }
        };
        
        // Standard game creation
        window.createGame = async function() {
            const duration = parseInt(document.getElementById('duration').value);
            const btc = parseInt(document.getElementById('btc').value);
            const eth = parseInt(document.getElementById('eth').value);
            const sol = parseInt(document.getElementById('sol').value);
            
            if (btc + eth + sol !== 10) {
                log('Allocations must sum to 10!', 'error');
                return;
            }
            
            log(`Creating ${duration}-day game with allocations BTC:${btc} ETH:${eth} SOL:${sol}...`, 'info');
            
            try {
                const result = await createNowGame({
                    duration: duration,
                    allocations: { BTC: btc, ETH: eth, SOL: sol }
                });
                
                currentGameId = result.game_id;
                log(`Game created! Code: ${formatGameCode(result.game_code)}`, 'success');
                log(`Starting prices: BTC=$${result.starting_prices.BTC}, ETH=$${result.starting_prices.ETH}, SOL=$${result.starting_prices.SOL}`, 'info');
                loadUserGames();
            } catch (error) {
                log(`Create failed: ${error.message}`, 'error');
            }
        };
        
        // Edge case: bad allocation
        window.createGameBadAllocation = async function() {
            log('Testing bad allocation (sum ‚â† 10)...', 'info');
            try {
                const result = await createNowGame({
                    duration: 30,
                    allocations: { BTC: 5, ETH: 3, SOL: 1 }
                });
                log('ERROR: Should have failed!', 'error');
            } catch (error) {
                log(`Correctly rejected: ${error.message}`, 'success');
            }
        };
        
        // Find game
        window.findGame = async function() {
            const code = document.getElementById('gameCode').value;
            if (code.length !== 4) {
                log('Code must be exactly 4 characters', 'error');
                return;
            }
            
            log(`Finding game with code: ${code}...`, 'info');
            try {
                foundGame = await findGameByCode(code);
                
                if (foundGame) {
                    log(`Found game! ${foundGame.duration_days} days, ${foundGame.participant_count} players`, 'success');
                    document.getElementById('foundGameDetails').textContent = 
                        `${foundGame.duration_days}-day game with ${foundGame.participant_count} player(s)`;
                    document.getElementById('foundGameInfo').style.display = 'block';
                } else {
                    log('Game not found', 'error');
                    document.getElementById('foundGameInfo').style.display = 'none';
                }
            } catch (error) {
                log(`Find failed: ${error.message}`, 'error');
            }
        };
        
        // Test wrong case
        window.findGameWrongCase = async function() {
            const code = document.getElementById('gameCode').value;
            if (code.length !== 4) {
                log('Enter a code first', 'error');
                return;
            }
            
            // Try with different case
            const wrongCase = code.toLowerCase() === code ? code.toUpperCase() : code.toLowerCase();
            log(`Testing wrong case: ${code} ‚Üí ${wrongCase}...`, 'info');
            
            try {
                const game = await findGameByCode(wrongCase);
                if (game) {
                    log('ERROR: Found game with wrong case! Case sensitivity broken!', 'error');
                } else {
                    log('Correct: Game not found with wrong case', 'success');
                }
            } catch (error) {
                log('Correct: Game not found with wrong case', 'success');
            }
        };
        
        // Join found game
        window.joinFoundGame = async function() {
            if (!foundGame) {
                log('Find a game first', 'error');
                return;
            }
            
            log(`Joining game ${formatGameCode(foundGame.game_code)}...`, 'info');
            try {
                const result = await joinNowGame({
                    gameId: foundGame.id,
                    allocations: { BTC: 4, ETH: 3, SOL: 3 }
                });
                log('Successfully joined game!', 'success');
                loadUserGames();
            } catch (error) {
                log(`Join failed: ${error.message}`, 'error');
            }
        };
        
        // Show my games
        window.showMyGames = async function() {
            log('Loading my games...', 'info');
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    log('Not authenticated', 'error');
                    return;
                }
                
                // Get games I created
                const { data: created } = await supabaseClient
                    .from('active_games')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('is_multiplayer', true);
                    
                // Get games I joined
                const { data: participations } = await supabaseClient
                    .from('game_participants')
                    .select('game_id')
                    .eq('user_id', user.id);
                    
                log(`Games created: ${created?.length || 0}`, 'info');
                created?.forEach(game => {
                    log(`  - ${formatGameCode(game.game_code)}: ${game.duration_days} days, ${game.participant_count} players`, 'info');
                });
                
                log(`Games joined: ${participations?.length || 0}`, 'info');
            } catch (error) {
                log(`Error loading games: ${error.message}`, 'error');
            }
        };
        
        // View leaderboard
        window.viewLeaderboard = async function() {
            const gameId = document.getElementById('gameSelect').value;
            if (!gameId) {
                log('Select a game first', 'error');
                return;
            }
            
            log('Loading leaderboard...', 'info');
            try {
                const participants = await getGameParticipants(gameId);
                
                log(`\n=== LEADERBOARD (${participants.length} players) ===`, 'info');
                participants.sort((a, b) => b.current_value - a.current_value);
                
                participants.forEach((p, index) => {
                    const rank = index + 1;
                    const value = (p.current_value / 1000000).toFixed(2);
                    const profit = ((p.current_value - p.starting_value) / p.starting_value * 100).toFixed(2);
                    const allocs = Object.entries(p.allocations)
                        .map(([k, v]) => `${k}:${v}`)
                        .join(' ');
                    
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                    log(`${medal} ${p.profiles?.email || 'Unknown'}: $${value}M (${profit >= 0 ? '+' : ''}${profit}%) [${allocs}]`, 'info');
                });
            } catch (error) {
                log(`Error loading leaderboard: ${error.message}`, 'error');
            }
        };
        
        // Edge cases
        window.joinOwnGame = async function() {
            if (!currentGameId) {
                log('Create a game first', 'error');
                return;
            }
            
            log('Attempting to join own game...', 'info');
            try {
                const result = await joinNowGame({
                    gameId: currentGameId,
                    allocations: { BTC: 5, ETH: 3, SOL: 2 }
                });
                log('ERROR: Should not be able to join own game!', 'error');
            } catch (error) {
                log(`Correctly rejected: ${error.message}`, 'success');
            }
        };
        
        // Price refresh
        window.refreshPrices = async function() {
            log('Checking price update status...', 'info');
            try {
                const { data: prices } = await supabaseClient
                    .from('prices_cache')
                    .select('symbol, price, fetched_at')
                    .order('symbol');
                    
                log('Current prices:', 'info');
                prices?.forEach(p => {
                    const age = Math.floor((Date.now() - new Date(p.fetched_at).getTime()) / 60000);
                    log(`  ${p.symbol}: $${p.price} (${age} minutes old)`, 'info');
                });
            } catch (error) {
                log(`Error checking prices: ${error.message}`, 'error');
            }
        };
        
        // Show all active games
        window.showAllActiveGames = async function() {
            log('Loading all active multiplayer games...', 'info');
            try {
                const { data: games } = await supabaseClient
                    .from('active_games')
                    .select('*')
                    .eq('is_multiplayer', true)
                    .eq('is_complete', false)
                    .order('created_at', { ascending: false });
                    
                log(`Found ${games?.length || 0} active games:`, 'info');
                games?.forEach(game => {
                    const remaining = Math.ceil((new Date(game.ends_at) - new Date()) / (1000 * 60 * 60 * 24));
                    log(`  ${formatGameCode(game.game_code)}: ${game.participant_count} players, ${remaining} days left`, 'info');
                });
            } catch (error) {
                log(`Error loading games: ${error.message}`, 'error');
            }
        };
        
        // More edge cases
        window.createGameAllBTC = () => createNowGame({ duration: 30, allocations: { BTC: 10, ETH: 0, SOL: 0 } })
            .then(r => log(`All-BTC game created: ${formatGameCode(r.game_code)}`, 'success'))
            .catch(e => log(`Error: ${e.message}`, 'error'));
            
        window.joinWithDifferentAllocation = () => {
            if (!foundGame) {
                log('Find a game first', 'error');
                return;
            }
            return joinNowGame({ gameId: foundGame.id, allocations: { BTC: 1, ETH: 1, SOL: 8 } })
                .then(() => log('Joined with different allocation!', 'success'))
                .catch(e => log(`Error: ${e.message}`, 'error'));
        };
        
        // Initialize on load
        window.addEventListener('load', initializeSupabase);
    </script>
</body>
</html> 